<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Homework Submission Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 12px;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--dark);
    }

    .container {
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.2rem;
      color: var(--dark);
      margin-bottom: 10px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .header p {
      color: var(--gray);
      font-size: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      padding: 20px;
    }

    .card-header h2 {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-body {
      padding: 30px;
    }

    @media (max-width: 768px) {
      .card-body {
        padding: 20px;
      }
      .header h1 {
        font-size: 1.8rem;
      }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-label i {
      color: var(--primary);
    }

    .form-control {
      width: 100%;
      padding: 15px;
      border: 2px solid var(--gray-light);
      border-radius: 8px;
      font-size: 1rem;
      transition: var(--transition);
      background-color: white;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .custom-file-upload {
      display: block;
      padding: 20px;
      border: 2px dashed var(--gray-light);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      background-color: #fafbfc;
    }

    .custom-file-upload i {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 10px;
    }

    .file-info {
      font-size: 0.9rem;
      color: var(--gray);
      margin-top: 5px;
    }

    .file-name {
      font-weight: 600;
      color: var(--dark);
      margin-top: 5px;
      display: block;
      word-break: break-all;
    }

    .submit-btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 16px;
      font-size: 1.1rem;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .progress-container {
      margin-top: 20px;
      display: none;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .progress-label {
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }

    .progress-percentage {
      font-weight: 700;
      color: var(--primary);
      font-size: 0.9rem;
    }

    .progress-bar {
      height: 10px;
      background-color: var(--gray-light);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, var(--success), var(--primary-light));
      border-radius: 5px;
      transition: width 0.3s ease;
    }

    .progress-status {
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--gray);
      min-height: 20px;
    }

    .status-error {
      color: var(--danger);
    }

    .loader {
      display: none;
      text-align: center;
      margin: 20px 0;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(67, 97, 238, 0.1);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .success-animation {
      text-align: center;
      margin: 20px 0;
      display: none;
    }

    .success-icon {
      width: 60px;
      height: 60px;
      background: #4caf50;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
    }

    .success-icon i {
      color: white;
      font-size: 1.8rem;
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      color: var(--gray);
      font-size: 0.8rem;
    }

    .warning-note {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 12px;
      margin-top: 15px;
      font-size: 0.85rem;
      color: #856404;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .network-status {
      position: fixed;
      top: 10px;
      right: 10px;
      left: 10px;
      background: #f44336;
      color: white;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .network-status.online {
      background: #4caf50;
    }
  </style>
</head>
<body>
  <div id="networkStatus" class="network-status">No internet connection</div>
  
  <div class="container">
    <div class="header">
      <h1>ðŸ“š Homework Submission Portal</h1>
      <p>Submit your assignments easily</p>
    </div>

    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-file-upload"></i> Assignment Details</h2>
      </div>
      
      <div class="card-body">
        <form id="homeworkForm">
          <div class="form-group">
            <label class="form-label" for="subject">
              <i class="fas fa-book"></i> Subject
            </label>
            <select class="form-control" id="subject" required>
              <option value="" disabled selected>Select a subject</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="name">
              <i class="fas fa-user"></i> Student Name
            </label>
            <select class="form-control" id="name" required>
              <option value="" disabled selected>Select your name</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="semester">
              <i class="fas fa-calendar-alt"></i> Semester
            </label>
            <select class="form-control" id="semester" required>
              <option value="" disabled selected>Select semester</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-paperclip"></i> Upload File
            </label>
            <div class="custom-file-upload" id="fileUploadArea">
              <i class="fas fa-cloud-upload-alt"></i>
              <div>Click to select file</div>
              <div class="file-info">Max 10MB for mobile</div>
              <span class="file-name" id="fileName">No file selected</span>
            </div>
            <input type="file" id="fileInput" hidden required>
          </div>

          <button type="submit" class="submit-btn" id="submitBtn">
            <i class="fas fa-file-upload"></i> Upload Assignment
          </button>

          <!-- Progress Bar -->
          <div class="progress-container" id="progressContainer">
            <div class="progress-header">
              <span class="progress-label">Uploading</span>
              <span class="progress-percentage" id="progressPercentage">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-status" id="progressStatus">Starting...</div>
          </div>

          <!-- Loading Spinner -->
          <div class="loader" id="loader">
            <div class="spinner"></div>
            <p>Processing...</p>
          </div>

          <!-- Success Animation -->
          <div class="success-animation" id="successAnimation">
            <div class="success-icon">
              <i class="fas fa-check"></i>
            </div>
            <h3>Success!</h3>
            <p id="successDetails">File uploaded successfully.</p>
            <div class="warning-note">
              <i class="fas fa-info-circle"></i>
              <div>Your submission has been sent.</div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="footer">
      <p>Need help? Contact academic support â€¢ v1.0</p>
    </div>
  </div>

  <script>
    // Configuration - SIMPLIFIED
    const BOT_TOKEN = "8346337831:AAEzYQFm6aGbY6vNQOmnPYSJ_OyJxW8YCBg";
    const CHAT_ID = "995413741";
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUKrkas2V7UzPosQ-RcqKLFJ8ZDd-mKhi1wUN-3lxlFhqLFTkK9G7LM5ddf0owQUio29gXnQu82HQQ/pub?output=csv';
    
    // Check if mobile
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    
    // DOM Elements
    const fileInput = document.getElementById('fileInput');
    const fileNameDisplay = document.getElementById('fileName');
    const submitBtn = document.getElementById('submitBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressFill = document.getElementById('progressFill');
    const progressStatus = document.getElementById('progressStatus');
    const successAnimation = document.getElementById('successAnimation');
    const successDetails = document.getElementById('successDetails');
    const networkStatus = document.getElementById('networkStatus');

    // Show/hide network status
    function updateNetworkStatus() {
      if (!navigator.onLine) {
        networkStatus.style.display = 'block';
        networkStatus.textContent = 'âš ï¸ No internet connection';
        networkStatus.className = 'network-status';
      } else {
        networkStatus.style.display = 'block';
        networkStatus.textContent = 'âœ“ Online';
        networkStatus.className = 'network-status online';
        setTimeout(() => {
          networkStatus.style.display = 'none';
        }, 2000);
      }
    }

    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);
    updateNetworkStatus(); // Initial check

    // Load CSV data for dropdowns
    async function loadCsvData() {
      try {
        const response = await fetch(CSV_URL);
        const text = await response.text();
        const rows = text.trim().split('\n');
        
        // Assuming first row is header
        const headers = rows[0].split(',').map(h => h.trim());
        const data = rows.slice(1).map(row => {
          const cells = row.split(',');
          let obj = {};
          headers.forEach((h, i) => obj[h] = cells[i]?.trim());
          return obj;
        });

        // Populate subjects
        const subjectSelect = document.getElementById('subject');
        const uniqueSubjects = [...new Set(data.map(d => d["Course Name"] || d["Subject"] || d["Course"]))].filter(Boolean);
        
        uniqueSubjects.forEach(s => {
          const option = document.createElement("option");
          option.value = s;
          option.textContent = s;
          subjectSelect.appendChild(option);
        });

        subjectSelect.addEventListener("change", loadNamesAndSemesters);
        loadNamesAndSemesters();
        
      } catch (error) {
        console.error("Error loading data:", error);
        // Fallback options
        const subjects = ["Mathematics", "Physics", "Chemistry", "Biology", "English", "Computer Science"];
        const subjectSelect = document.getElementById('subject');
        subjects.forEach(s => {
          const option = document.createElement("option");
          option.value = s;
          option.textContent = s;
          subjectSelect.appendChild(option);
        });
        loadNamesAndSemesters();
      }
    }

    function loadNamesAndSemesters() {
      const subject = document.getElementById('subject').value;
      const nameSelect = document.getElementById('name');
      const semesterSelect = document.getElementById('semester');
      
      nameSelect.innerHTML = '<option value="" disabled selected>Select your name</option>';
      semesterSelect.innerHTML = '<option value="" disabled selected>Select semester</option>';

      if (!subject) return;

      // Simple fallback - you should replace this with actual data
      const names = ["Student 1", "Student 2", "Student 3", "Student 4", "Student 5"];
      const semesters = ["Semester 1", "Semester 2", "Semester 3", "Semester 4", "Semester 5", "Semester 6"];
      
      names.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        nameSelect.appendChild(option);
      });
      
      semesters.forEach(semester => {
        const option = document.createElement("option");
        option.value = semester;
        option.textContent = semester;
        semesterSelect.appendChild(option);
      });
    }

    // File selection
    fileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        const file = this.files[0];
        fileNameDisplay.textContent = file.name + ` (${formatFileSize(file.size)})`;
        
        // Mobile-specific file size limit
        const maxSize = isMobile ? 10 * 1024 * 1024 : 50 * 1024 * 1024;
        
        if (file.size > maxSize) {
          fileNameDisplay.textContent = "File too large!";
          fileNameDisplay.style.color = "var(--danger)";
          fileInput.value = "";
          showError(`File size exceeds ${isMobile ? '10MB' : '50MB'} limit.`);
          return;
        }
        
        fileNameDisplay.style.color = "var(--dark)";
      } else {
        fileNameDisplay.textContent = "No file selected";
        fileNameDisplay.style.color = "var(--dark)";
      }
    });

    document.getElementById('fileUploadArea').addEventListener('click', () => fileInput.click());

    // Form submission - SIMPLIFIED VERSION
    document.getElementById("homeworkForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const file = fileInput.files[0];
      const subject = document.getElementById('subject').value;
      const name = document.getElementById('name').value;
      const semester = document.getElementById('semester').value;

      if (!file || !subject || !name || !semester) {
        showError("Please fill all fields!");
        return;
      }

      // Check network
      if (!navigator.onLine) {
        showError("No internet connection. Please check your network.");
        return;
      }

      // Disable button and show progress
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
      progressContainer.style.display = "block";
      progressFill.style.width = "0%";
      progressPercentage.textContent = "0%";
      progressStatus.textContent = "Starting upload...";

      // Create simple caption
      const caption = `Homework Submission\nStudent: ${name}\nSubject: ${subject}\nSemester: ${semester}\nFile: ${file.name}`;

      try {
        // SIMPLE UPLOAD - No fancy timeouts, just basic fetch
        console.log("Starting simple upload...");
        
        const formData = new FormData();
        formData.append('chat_id', CHAT_ID);
        formData.append('document', file);
        formData.append('caption', caption);
        
        // Show progress
        let progress = 0;
        const progressInterval = setInterval(() => {
          if (progress < 90) {
            progress += 10;
            progressFill.style.width = `${progress}%`;
            progressPercentage.textContent = `${progress}%`;
            progressStatus.textContent = progress < 50 ? "Uploading..." : "Processing...";
          }
        }, 500);

        // Make the request
        const response = await fetch(
          `https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`,
          {
            method: 'POST',
            body: formData
          }
        );

        clearInterval(progressInterval);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Upload failed: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.ok) {
          // Success!
          progressFill.style.width = "100%";
          progressPercentage.textContent = "100%";
          progressStatus.textContent = "Complete!";
          
          setTimeout(() => {
            progressContainer.style.display = "none";
            successAnimation.style.display = "block";
            successDetails.textContent = `${subject} - ${name} - ${file.name}`;
            
            // Reset form after delay
            setTimeout(() => {
              resetForm();
            }, 3000);
          }, 1000);
          
        } else {
          throw new Error(result.description || 'Upload failed');
        }
        
      } catch (error) {
        console.error("Upload error:", error);
        
        let errorMessage = error.message;
        
        // Mobile-specific error messages
        if (isMobile) {
          if (errorMessage.includes('NetworkError') || errorMessage.includes('Failed to fetch')) {
            errorMessage = "Network issue. Try WiFi instead of mobile data.";
          } else if (errorMessage.includes('timeout')) {
            errorMessage = "Upload took too long. Try smaller file.";
          }
        }
        
        showError(errorMessage);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-file-upload"></i> Upload Assignment';
      }
    });

    function showError(message) {
      progressStatus.textContent = message;
      progressStatus.className = "progress-status status-error";
      progressContainer.style.display = "block";
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        progressContainer.style.display = "none";
      }, 5000);
    }

    function resetForm() {
      document.getElementById("homeworkForm").reset();
      fileNameDisplay.textContent = "No file selected";
      successAnimation.style.display = "none";
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-file-upload"></i> Upload Assignment';
      
      // Reload dropdowns
      loadNamesAndSemesters();
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Initialize on load
    window.addEventListener('load', function() {
      loadCsvData();
      
      // Mobile-specific optimizations
      if (isMobile) {
        console.log("Mobile device detected - applying optimizations");
        // Add touch-friendly styles
        document.querySelectorAll('.form-control, .submit-btn').forEach(el => {
          el.style.minHeight = '44px'; // Apple's recommended touch target size
        });
      }
    });
  </script>
</body>
</html>
