<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Homework Submission Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 12px;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--dark);
    }

    .container {
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 2.8rem;
      color: var(--dark);
      margin-bottom: 10px;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .header p {
      color: var(--gray);
      font-size: 1.1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
    }

    .card-header {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      padding: 25px 30px;
    }

    .card-header h2 {
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-body {
      padding: 40px;
    }

    @media (max-width: 768px) {
      .card-body {
        padding: 30px 20px;
      }
    }

    .form-group {
      margin-bottom: 25px;
      position: relative;
    }

    .form-label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--dark);
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-label i {
      color: var(--primary);
    }

    .form-control {
      width: 100%;
      padding: 16px 18px;
      border: 2px solid var(--gray-light);
      border-radius: 10px;
      font-size: 1rem;
      transition: var(--transition);
      background-color: white;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .form-control::placeholder {
      color: #adb5bd;
    }

    .custom-file-upload {
      display: block;
      padding: 20px;
      border: 2px dashed var(--gray-light);
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      background-color: #fafbfc;
    }

    .custom-file-upload:hover {
      border-color: var(--primary-light);
      background-color: rgba(67, 97, 238, 0.03);
    }

    .custom-file-upload i {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .file-info {
      font-size: 1rem;
      color: var(--gray);
      margin-top: 8px;
    }

    .file-name {
      font-weight: 600;
      color: var(--dark);
      margin-top: 5px;
      display: block;
    }

    .submit-btn {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      border: none;
      border-radius: 10px;
      padding: 18px 30px;
      font-size: 1.2rem;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
    }

    .submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(67, 97, 238, 0.3);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Progress Bar */
    .progress-container {
      margin-top: 30px;
      display: none;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .progress-label {
      font-weight: 600;
      color: var(--dark);
    }

    .progress-percentage {
      font-weight: 700;
      color: var(--primary);
    }

    .progress-bar {
      height: 12px;
      background-color: var(--gray-light);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, var(--success), var(--primary-light));
      border-radius: 6px;
      transition: width 0.5s ease;
    }

    .progress-status {
      text-align: center;
      font-weight: 600;
      color: var(--gray);
      min-height: 24px;
    }

    .status-success {
      color: #2ecc71;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 1.1rem;
    }

    .status-error {
      color: var(--danger);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .loader {
      display: none;
      text-align: center;
      margin: 30px 0;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(67, 97, 238, 0.1);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .success-animation {
      text-align: center;
      margin: 30px 0;
      display: none;
    }

    .success-checkmark {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      position: relative;
    }

    .check-icon {
      width: 80px;
      height: 80px;
      position: relative;
      border-radius: 50%;
      box-sizing: content-box;
      border: 4px solid #4caf50;
    }

    .check-icon::before {
      top: 3px;
      left: -2px;
      width: 30px;
      transform-origin: 100% 50%;
      border-radius: 100px 0 0 100px;
    }

    .check-icon::after {
      top: 0;
      left: 30px;
      width: 60px;
      transform-origin: 0 50%;
      border-radius: 0 100px 100px 0;
      animation: rotate-circle 4.25s ease-in;
    }

    .check-icon .icon-line {
      height: 5px;
      background-color: #4caf50;
      display: block;
      border-radius: 2px;
      position: absolute;
      z-index: 10;
    }

    .check-icon .line-tip {
      top: 46px;
      left: 14px;
      width: 25px;
      transform: rotate(45deg);
      animation: icon-line-tip 0.75s;
    }

    .check-icon .line-long {
      top: 38px;
      right: 8px;
      width: 47px;
      transform: rotate(-45deg);
      animation: icon-line-long 0.75s;
    }

    @keyframes rotate-circle {
      0% { transform: rotate(-45deg); }
      5% { transform: rotate(-45deg); }
      12% { transform: rotate(-405deg); }
      100% { transform: rotate(-405deg); }
    }

    @keyframes icon-line-tip {
      0% { width: 0; left: 1px; top: 19px; }
      54% { width: 0; left: 1px; top: 19px; }
      70% { width: 50px; left: -8px; top: 37px; }
      84% { width: 17px; left: 21px; top: 48px; }
      100% { width: 25px; left: 14px; top: 45px; }
    }

    @keyframes icon-line-long {
      0% { width: 0; right: 46px; top: 54px; }
      65% { width: 0; right: 46px; top: 54px; }
      84% { width: 55px; right: 0; top: 35px; }
      100% { width: 47px; right: 8px; top: 38px; }
    }

    .footer {
      text-align: center;
      margin-top: 40px;
      color: var(--gray);
      font-size: 0.9rem;
    }

    .footer a {
      color: var(--primary);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    .warning-note {
      background-color: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-size: 0.9rem;
      color: #856404;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .warning-note i {
      color: #ffc107;
      font-size: 1.2rem;
    }

    .upload-info {
      background-color: #e3f2fd;
      border-radius: 8px;
      padding: 12px 15px;
      margin-top: 5px;
      font-size: 0.85rem;
      color: #0d47a1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .upload-info i {
      color: #0088cc;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ“š Homework Submission Portal</h1>
      <p>Submit your assignments easily and track upload progress in real-time.</p>
    </div>

    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-file-upload"></i> Assignment Details</h2>
      </div>
      
      <div class="card-body">
        <form id="homeworkForm">
          <div class="form-group">
            <label class="form-label" for="subject">
              <i class="fas fa-book"></i> Subject
            </label>
            <select class="form-control" id="subject" required>
              <option value="" disabled selected>Select a subject</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="name">
              <i class="fas fa-user"></i> Student Name
            </label>
            <select class="form-control" id="name" required>
              <option value="" disabled selected>Select your name</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="semester">
              <i class="fas fa-calendar-alt"></i> Semester
            </label>
            <select class="form-control" id="semester" required>
              <option value="" disabled selected>Select semester</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-paperclip"></i> Upload File
            </label>
            <div class="custom-file-upload" id="fileUploadArea">
              <i class="fas fa-cloud-upload-alt"></i>
              <div>Drag & drop your file here or click to browse</div>
              <div class="file-info">Supports: PDF, DOC, DOCX, PPT, ZIP, JPG, PNG (Max 50MB)</div>
              <span class="file-name" id="fileName">No file selected</span>
            </div>
            <input type="file" id="fileInput" hidden required>
          </div>

          <div class="upload-info">
            <i class="fas fa-info-circle"></i>
            Your submission will be sent directly to your teacher.
          </div>

          <button type="submit" class="submit-btn" id="submitBtn">
            <i class="fas fa-file-upload"></i> Upload Assignment
          </button>

          <!-- Progress Bar -->
          <div class="progress-container" id="progressContainer">
            <div class="progress-header">
              <span class="progress-label">Uploading Assignment</span>
              <span class="progress-percentage" id="progressPercentage">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-status" id="progressStatus">Preparing upload...</div>
          </div>

          <!-- Loading Spinner -->
          <div class="loader" id="loader">
            <div class="spinner"></div>
            <p>Processing your submission...</p>
          </div>

          <!-- Success Animation -->
          <div class="success-animation" id="successAnimation">
            <div class="success-checkmark">
              <div class="check-icon">
                <span class="icon-line line-tip"></span>
                <span class="icon-line line-long"></span>
                <div class="icon-circle"></div>
              </div>
            </div>
            <h3>Assignment Submitted Successfully!</h3>
            <p id="successDetails">Your file has been uploaded successfully.</p>
            <div class="warning-note">
              <i class="fas fa-info-circle"></i>
              <div>Your submission has been recorded and sent to the teacher.</div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="footer">
      <p>Need help? Contact <a href="mailto:support@university.edu">academic support</a> â€¢ Secure SSL Connection ðŸ”’</p>
    </div>
  </div>

  <script>
    // Configuration
    const BOT_TOKEN = "8346337831:AAEzYQFm6aGbY6vNQOmnPYSJ_OyJxW8YCBg";
    const CHAT_ID = "995413741";
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUKrkas2V7UzPosQ-RcqKLFJ8ZDd-mKhi1wUN-3lxlFhqLFTkK9G7LM5ddf0owQUio29gXnQu82HQQ/pub?output=csv';
    const TRACKING_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzLnMWyDaO3QAQdXeVqy33TjxfVtCvZjmweUUVBEqfafnrG5FAS0cym1uchP-QitLwh/exec';
    
    let data = [];
    let currentSubmission = null;

    // DOM Elements
    const fileInput = document.getElementById('fileInput');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileNameDisplay = document.getElementById('fileName');
    const submitBtn = document.getElementById('submitBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressFill = document.getElementById('progressFill');
    const progressStatus = document.getElementById('progressStatus');
    const loader = document.getElementById('loader');
    const successAnimation = document.getElementById('successAnimation');
    const successDetails = document.getElementById('successDetails');

    // Function to escape special characters
    function escapeText(text) {
      if (!text) return '';
      return String(text)
        .replace(/_/g, '\\_')
        .replace(/\*/g, '\\*')
        .replace(/\[/g, '\\[')
        .replace(/\]/g, '\\]')
        .replace(/\(/g, '\\(')
        .replace(/\)/g, '\\)')
        .replace(/~/g, '\\~')
        .replace(/`/g, '\\`')
        .replace(/>/g, '\\>')
        .replace(/#/g, '\\#')
        .replace(/\+/g, '\\+')
        .replace(/-/g, '\\-')
        .replace(/=/g, '\\=')
        .replace(/\|/g, '\\|')
        .replace(/\{/g, '\\{')
        .replace(/\}/g, '\\}')
        .replace(/\./g, '\\.')
        .replace(/!/g, '\\!');
    }

    // Function to track submission in Google Sheets
    async function trackSubmission(submissionData) {
      try {
        const trackingData = {
          timestamp: new Date().toISOString(),
          studentName: submissionData.name,
          subject: submissionData.subject,
          semester: submissionData.semester,
          fileName: submissionData.fileName,
          fileSize: submissionData.fileSize,
          telegramFileId: submissionData.telegramFileId || '',
          status: 'submitted'
        };

        // Send data to Google Apps Script
        const response = await fetch(TRACKING_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(trackingData)
        });
        
        console.log('Submission tracked successfully');
        return true;
      } catch (error) {
        console.error('Error tracking submission:', error);
        throw new Error('Failed to record in Google Sheets');
      }
    }

    // Load CSV data for dropdowns
    async function loadCsvData() {
      try {
        const response = await fetch(CSV_URL);
        const text = await response.text();
        const rows = text.trim().split('\n').map(r => r.split(','));
        const headers = rows[0];

        data = rows.slice(1).map(row => {
          let obj = {};
          headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim());
          return obj;
        });

        // Populate subjects
        const subjectSelect = document.getElementById('subject');
        const uniqueSubjects = [...new Set(data.map(d => d["Course Name"]))];
        
        uniqueSubjects.forEach(s => {
          let opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          subjectSelect.appendChild(opt);
        });

        subjectSelect.addEventListener("change", loadNamesAndSemesters);
        loadNamesAndSemesters();
      } catch (error) {
        console.error("Error loading CSV data:", error);
        showError("Error loading course data. Please refresh the page.");
      }
    }

    // Load names and semesters based on selected subject
    function loadNamesAndSemesters() {
      const subject = document.getElementById('subject').value;
      const nameSelect = document.getElementById('name');
      const semesterSelect = document.getElementById('semester');
      
      nameSelect.innerHTML = '<option value="" disabled selected>Select your name</option>';
      semesterSelect.innerHTML = '<option value="" disabled selected>Select semester</option>';

      if (!subject) return;

      // Filter data for selected subject
      const filteredData = data.filter(d => d["Course Name"] === subject);
      
      // Get unique names
      const uniqueNames = [...new Set(filteredData.map(d => d["Name"]))];
      uniqueNames.forEach(n => {
        let opt = document.createElement("option");
        opt.value = n;
        opt.textContent = n;
        nameSelect.appendChild(opt);
      });

      // Get unique semesters
      let uniqueSemesters = [];
      if (filteredData.length > 0 && filteredData[0]["Semester"]) {
        uniqueSemesters = [...new Set(filteredData.map(d => d["Semester"]))];
      }
      
      // If no Semester column found, use a fallback
      if (uniqueSemesters.length === 0) {
        uniqueSemesters = ["Semester 1", "Semester 2", "Semester 3", "Semester 4", 
                          "Semester 5", "Semester 6", "Semester 7", "Semester 8"];
      }
      
      uniqueSemesters.forEach(s => {
        let opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        semesterSelect.appendChild(opt);
      });

      // Add event listener to name dropdown to filter semesters further if needed
      nameSelect.addEventListener("change", function() {
        const selectedName = this.value;
        if (selectedName && subject) {
          // Filter semesters for the specific name and subject
          const nameFilteredData = data.filter(d => 
            d["Course Name"] === subject && d["Name"] === selectedName
          );
          
          // If Semester column exists and has values for this student
          if (nameFilteredData.length > 0 && nameFilteredData[0]["Semester"]) {
            const nameSpecificSemesters = [...new Set(nameFilteredData.map(d => d["Semester"]))];
            
            if (nameSpecificSemesters.length > 0) {
              semesterSelect.innerHTML = '<option value="" disabled selected>Select semester</option>';
              nameSpecificSemesters.forEach(s => {
                let opt = document.createElement("option");
                opt.value = s;
                opt.textContent = s;
                semesterSelect.appendChild(opt);
              });
            }
          }
        }
      });
    }

    // File upload handling
    fileUploadArea.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        const file = this.files[0];
        fileNameDisplay.textContent = file.name;
        fileUploadArea.style.borderColor = "var(--primary-light)";
        fileUploadArea.style.backgroundColor = "rgba(67, 97, 238, 0.05)";
        
        // Validate file size (max 50MB)
        if (file.size > 50 * 1024 * 1024) {
          fileNameDisplay.textContent = "File too large! Max 50MB";
          fileNameDisplay.style.color = "var(--danger)";
          fileInput.value = "";
          showError("File size exceeds 50MB limit. Please compress your file.");
          return;
        }
        
        fileNameDisplay.style.color = "var(--dark)";
      } else {
        fileNameDisplay.textContent = "No file selected";
        fileNameDisplay.style.color = "var(--dark)";
        fileUploadArea.style.borderColor = "var(--gray-light)";
        fileUploadArea.style.backgroundColor = "#fafbfc";
      }
    });

    // Drag and drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      fileUploadArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      fileUploadArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      fileUploadArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      fileUploadArea.style.borderColor = "var(--primary)";
      fileUploadArea.style.backgroundColor = "rgba(67, 97, 238, 0.1)";
    }

    function unhighlight() {
      fileUploadArea.style.borderColor = "var(--gray-light)";
      fileUploadArea.style.backgroundColor = "#fafbfc";
      
      if (fileInput.files.length > 0) {
        fileUploadArea.style.borderColor = "var(--primary-light)";
        fileUploadArea.style.backgroundColor = "rgba(67, 97, 238, 0.05)";
      }
    }

    fileUploadArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      fileInput.files = files;
      
      if (files.length > 0) {
        const file = files[0];
        fileNameDisplay.textContent = file.name;
        
        // Validate file size
        if (file.size > 50 * 1024 * 1024) {
          fileNameDisplay.textContent = "File too large! Max 50MB";
          fileNameDisplay.style.color = "var(--danger)";
          fileInput.value = "";
          showError("File size exceeds 50MB limit. Please compress your file.");
          return;
        }
        
        fileNameDisplay.style.color = "var(--dark)";
        fileUploadArea.style.borderColor = "var(--primary-light)";
        fileUploadArea.style.backgroundColor = "rgba(67, 97, 238, 0.05)";
      }
    }

    // Form submission handler
    document.getElementById("homeworkForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const file = fileInput.files[0];
      const subject = document.getElementById('subject').value;
      const name = document.getElementById('name').value;
      const semester = document.getElementById('semester').value;

      // Validate form
      if (!file || !subject || !name || !semester) {
        showError("Please fill all fields and select a file!");
        return;
      }

      // Store submission data
      currentSubmission = {
        name: name,
        subject: subject,
        semester: semester,
        fileName: file.name,
        fileSize: formatFileSize(file.size),
        file: file,
        timestamp: new Date().toLocaleString()
      };

      // Show progress for Telegram upload only
      progressContainer.style.display = "block";
      submitBtn.disabled = true;
      loader.style.display = "none";
      successAnimation.style.display = "none";
      
      // Reset progress
      progressPercentage.textContent = "0%";
      progressFill.style.width = "0%";
      progressStatus.textContent = "Uploading to Telegram...";
      progressStatus.className = "progress-status";

      // Create caption for message
      const caption = `New Homework Submission\n\n` +
                     `Student: ${escapeText(name)}\n` +
                     `Subject: ${escapeText(subject)}\n` +
                     `Semester: ${escapeText(semester)}\n` +
                     `File: ${escapeText(file.name)}\n` +
                     `Size: ${formatFileSize(file.size)}\n` +
                     `Submitted: ${new Date().toLocaleString()}\n\n` +
                     `Submitted via Assignment Submission Portal`;

      // Create FormData for API
      const formData = new FormData();
      formData.append('chat_id', CHAT_ID);
      formData.append('document', file);
      formData.append('caption', caption);
      formData.append('parse_mode', 'HTML');

      try {
        // Step 1: Upload file to Telegram ONLY
        progressStatus.textContent = "Uploading to Telegram...";
        progressFill.style.width = "30%";
        progressPercentage.textContent = "30%";
        
        const response = await fetch(
          `https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`,
          {
            method: 'POST',
            body: formData
          }
        );

        const result = await response.json();
        
        if (response.ok && result.ok) {
          // Store Telegram file info
          currentSubmission.telegramFileId = result.result.document.file_id;
          currentSubmission.telegramResult = result;
          
          // Update progress
          progressFill.style.width = "70%";
          progressPercentage.textContent = "70%";
          progressStatus.textContent = "File uploaded successfully!";
          
          // Show confirmation step
          setTimeout(() => {
            progressContainer.style.display = "none";
            showConfirmationStep();
          }, 1000);
          
        } else {
          const errorMsg = result.description || 'Telegram upload failed';
          throw new Error(errorMsg);
        }

      } catch (error) {
        showError(`Upload failed: ${error.message}. Please try again.`);
        submitBtn.disabled = false;
        console.error("Upload error:", error);
      }
    });

    // Function to show confirmation step
    function showConfirmationStep() {
      // Create confirmation message
      const confirmationHTML = `
        <div class="warning-note" style="margin-top: 20px; background-color: #e8f5e9; border-color: #4caf50;">
          <i class="fas fa-check-circle" style="color: #4caf50;"></i>
          <div>
            <h3 style="margin-bottom: 10px; color: #2e7d32;">File Uploaded Successfully!</h3>
            <p><strong>File:</strong> ${currentSubmission.fileName} (${currentSubmission.fileSize})</p>
            <p><strong>Student:</strong> ${currentSubmission.name}</p>
            <p><strong>Subject:</strong> ${currentSubmission.subject}</p>
            <p><strong>Semester:</strong> ${currentSubmission.semester}</p>
            <p style="margin-top: 15px;">Please confirm to record this submission in Google Sheets.</p>
          </div>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
          <button id="confirmSubmitBtn" class="submit-btn" style="background: linear-gradient(to right, #4CAF50, #2E7D32);">
            <i class="fas fa-check-circle"></i> Confirm & Submit to Google Sheets
          </button>
          <button id="cancelBtn" class="submit-btn" style="background: linear-gradient(to right, #f44336, #c62828);">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      `;
      
      // Insert confirmation
      const form = document.getElementById('homeworkForm');
      const existingConfirmation = document.getElementById('confirmationStep');
      
      if (existingConfirmation) {
        existingConfirmation.remove();
      }
      
      const confirmationDiv = document.createElement('div');
      confirmationDiv.id = 'confirmationStep';
      confirmationDiv.innerHTML = confirmationHTML;
      form.appendChild(confirmationDiv);
      
      // Add event listeners for confirmation buttons
      document.getElementById('confirmSubmitBtn').addEventListener('click', confirmToGoogleSheets);
      document.getElementById('cancelBtn').addEventListener('click', cancelConfirmation);
    }

    // Function to confirm and submit to Google Sheets
    async function confirmToGoogleSheets() {
      const confirmBtn = document.getElementById('confirmSubmitBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      
      // Disable buttons
      confirmBtn.disabled = true;
      cancelBtn.disabled = true;
      confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting to Google Sheets...';
      
      // Show progress again
      document.getElementById('confirmationStep').style.display = 'none';
      progressContainer.style.display = "block";
      progressStatus.textContent = "Recording in Google Sheets...";
      progressFill.style.width = "80%";
      progressPercentage.textContent = "80%";
      
      try {
        // Step 2: Track submission in Google Sheets
        await trackSubmission(currentSubmission);
        
        // Complete the progress
        progressFill.style.width = "100%";
        progressPercentage.textContent = "100%";
        progressStatus.textContent = "Submission complete!";
        
        // Show success animation
        setTimeout(() => {
          progressContainer.style.display = "none";
          successAnimation.style.display = "block";
          
          // Display submission details
          document.getElementById('successDetails').textContent = 
            `${currentSubmission.subject} â€¢ ${currentSubmission.name} â€¢ ${currentSubmission.semester} â€¢ ${currentSubmission.fileName} (${currentSubmission.fileSize})`;
          
          // Reset everything after successful submission
          setTimeout(() => {
            resetForm();
          }, 5000);
        }, 1000);
        
      } catch (error) {
        showError(`Failed to record in Google Sheets: ${error.message}. Please try again.`);
        // Re-enable buttons
        confirmBtn.disabled = false;
        cancelBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm & Submit to Google Sheets';
      }
    }

    // Function to cancel confirmation
    function cancelConfirmation() {
      // Remove confirmation step
      const confirmationStep = document.getElementById('confirmationStep');
      if (confirmationStep) {
        confirmationStep.remove();
      }
      
      // Re-enable submit button
      submitBtn.disabled = false;
      
      // Reset data
      currentSubmission = null;
    }

    // Function to reset form
    function resetForm() {
      document.getElementById("homeworkForm").reset();
      fileNameDisplay.textContent = "No file selected";
      fileUploadArea.style.borderColor = "var(--gray-light)";
      fileUploadArea.style.backgroundColor = "#fafbfc";
      
      // Reset dropdowns to initial state
      document.getElementById('name').innerHTML = '<option value="" disabled selected>Select your name</option>';
      document.getElementById('semester').innerHTML = '<option value="" disabled selected>Select semester</option>';
      
      // Remove confirmation step if exists
      const confirmationStep = document.getElementById('confirmationStep');
      if (confirmationStep) {
        confirmationStep.remove();
      }
      
      // Hide success animation
      successAnimation.style.display = "none";
      submitBtn.disabled = false;
      
      // Reset data
      currentSubmission = null;
    }

    // Helper function to show error
    function showError(message) {
      progressStatus.textContent = message;
      progressStatus.className = "progress-status status-error";
      progressContainer.style.display = "block";
      
      // Hide after 5 seconds
      setTimeout(() => {
        progressContainer.style.display = "none";
      }, 5000);
    }

    // Helper function to format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Initialize the form when page loads
    window.onload = loadCsvData;
  </script>
</body>
</html>
